---
nextcloud:
  ldap_host: ldap
  ldap_port: 389
  ldap_base: "{{ conf['ldap_base_dn'] }}"
  ldap_agent_name: "cn={{ conf['ldap_readonly_user_username'] }},{{ conf['ldap_base_dn'] }}"
  ldap_agent_password: "{{ conf['ldap_readonly_user_password'] }}"
  ldap_email_attribute: mail
  ldap_gid_number: gidNumber
  ldap_group_display_name: description
  ldap_group_filter: "(&(|(objectclass=groupOfUniqueNames))(|(cn=colleagues)(cn=managers)))"
  ldap_group_filter_objectclass: groupOfUniqueNames
  ldap_group_member_assoc_attr: uniqueMember
  ldap_login_filter: "(&(&(|(objectclass=person))(|(memberof=cn=nextcloud_users,ou=groups,{{ conf['ldap_base_dn'] }})))(|(cn=%uid)))"
  ldap_login_filter_attributes: cn
  ldap_userdisplay_name: displayname
  ldap_user_filter: "(&(|(objectclass=person))(|(memberof=cn=nextcloud_users,ou=groups,{{ conf['ldap_base_dn'] }})))"
  ldap_user_filter_groups: nextcloud
  ldap_user_filter_objectclass: person
  ldap_configuration_active: 1
  apps:
    - { url: "https://github.com/nextcloud/mail/releases/download/v1.9.5/mail.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/mail.tar.gz" }
    - { url: "https://github.com/nextcloud/groupfolders/releases/download/v9.0.1/groupfolders.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/groupfolders.tar.gz" }
    - { url: "https://github.com/nextcloud/announcementcenter/releases/download/v5.0.0/announcementcenter-5.0.0.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/announcementcenter.tar.gz" }
    - { url: "https://github.com/nextcloud/contacts/releases/download/v3.5.1/contacts.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/contacts.tar.gz" }
    - { url: "https://github.com/nextcloud/notes/releases/download/v4.0.4/notes.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/notes.tar.gz" }
    - { url: "https://github.com/nextcloud/forms/releases/download/v2.2.4/forms.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/forms.tar.gz" }
    - { url: "https://github.com/nextcloud/news/releases/download/15.4.2/news.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/news.tar.gz" }
    - { url: "https://github.com/nextcloud/calendar/releases/download/v2.2.1/calendar.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/calendar.tar.gz" }
    - { url: "https://github.com/ONLYOFFICE/onlyoffice-nextcloud/releases/download/v6.3.0/onlyoffice.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/onlyoffice.tar.gz" }
    - { url: "https://github.com/pawelrojek/nextcloud-drawio/releases/download/v.1.0.0/drawio-v1.0.0.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/drawio.tar.gz" }
    - { url: "https://github.com/icewind1991/files_markdown/releases/download/v2.3.3/files_markdown.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/files_markdown.tar.gz" }
    - { url: "https://github.com/ACTom/files_mindmap/releases/download/v0.0.24/files_mindmap-0.0.24.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/files_mindmap.tar.gz" }
    - { url: "https://github.com/jhass/nextcloud-keeweb/releases/download/v0.6.5/keeweb-0.6.5.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/keeweb-0.6.5.tar.gz" }
    - { url: "https://github.com/nickv-nextcloud/event_update_notification/releases/download/v1.2.0/event_update_notification-1.2.0.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/event_update_notification-1.2.0.tar.gz" }
    - { url: "https://h-software.de/nextcloud_apps/ldapcontacts/ldapcontacts-2.0.5.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/ldapcontacts-2.0.5.tar.gz" }
    # can't connect to server
    # - { url: "https://git.mdns.eu/nextcloud/passwords/-/jobs/12123/artifacts/raw/passwords.tar.gz", dest: "{{ build_path }}/images/nextcloud/service/nextcloud/apps/passwords.tar.gz" }

nextcloud_docker_service: |2
    nextcloud_db:
      image:  {{registry_url}}{{project}}-nextcloud_db:latest
      container_name: {{project}}-nextcloud_db
      restart: always
      volumes:
        - {{docker_data_path}}/nextcloud/postgres-data:/var/lib/postgresql/data
      environment:
        POSTGRES_USER: nextcloud
        POSTGRES_PASSWORD: nextcloud
        POSTGRES_DB: nextcloud
        PGDATA: /var/lib/postgresql/data
      networks:
        - net

    nextcloud_redis:
      image:  {{registry_url}}{{project}}-nextcloud_redis:latest
      container_name: {{project}}-nextcloud_redis
      restart: always
      networks:
        - net

    nextcloud_onlyoffice_ds:
      image:  {{registry_url}}{{project}}-nextcloud_onlyoffice_ds:latest
      container_name: {{project}}-nextcloud_onlyoffice_ds
      restart: always
      volumes:
        - {{docker_data_path}}/nextcloud/onlyoffice_ds/var/www/onlyoffice/Data:/var/www/onlyoffice/Data
        - {{docker_data_path}}/nextcloud/onlyoffice_ds/var/log/onlyoffice:/var/log/onlyoffice
      networks:
        - net

    nextcloud_drawio_export_server:
      image:  {{registry_url}}{{project}}-nextcloud_drawio_export_server:latest
      container_name: {{project}}-nextcloud_drawio_export_server
      restart: always
      volumes:
        - {{docker_data_path}}/nextcloud/drawio/export-server/usr/share/fonts/drawio:/usr/share/fonts/drawio
      networks:
        - net

    nextcloud_drawio:
      image:  {{registry_url}}{{project}}-nextcloud_drawio:latest
      container_name: {{project}}-nextcloud_drawio
      restart: always
      environment:
        VIRTUAL_HOST: drawio.{{ conf['domain'] }}
        VIRTUAL_PORT: 8080
        EXPORT_URL: http://nextcloud_drawio_export_server:8000/
      depends_on:
        - nextcloud_drawio_export_server
      networks:
        - net

    nextcloud:
      image:  {{registry_url}}{{project}}-nextcloud:latest
      container_name: {{project}}-nextcloud
      restart: always
      volumes:
        - {{docker_data_path}}/nextcloud/nextcloud-data/var/www/html:/var/www/html
      environment:
        VIRTUAL_HOST: nextcloud.{{ conf['domain'] }}
        NEXTCLOUD_TRUSTED_DOMAINS: nextcloud nextcloud.{{ conf['domain'] }}

        NEXTCLOUD_ADMIN_USER: admin
        NEXTCLOUD_ADMIN_PASSWORD: {{ conf['nextcloud_admin_mail_account_password'] }}

        SMTP_HOST: {{ mailserv['hostname'] }}
        SMTP_PORT: 25
        SMTP_AUTHTYPE: LOGIN
        SMTP_NAME: nextcloud
        SMTP_PASSWORD: {{ conf['nextcloud_admin_mail_account_password'] }}
        MAIL_FROM_ADDRESS: nextcloud
        MAIL_DOMAIN: {{ mailserv['domain'] }}

        REDIS_HOST: nextcloud_redis
        POSTGRES_HOST: nextcloud_db
        POSTGRES_DB: nextcloud
        POSTGRES_USER: nextcloud
        POSTGRES_PASSWORD: nextcloud

        NEXTCLOUD_DRAWIO_URL: "https://drawio.{{ conf['domain'] }}/"

        NEXTCLOUD_ONLYOFFICE_DOCUMENT_SERVER_URL: "https://onlyoffice.{{ conf['domain'] }}/"
        NEXTCLOUD_ONLYOFFICE_DOCUMENT_SERVER_INTERNAL_URL: "http://nextcloud_onlyoffice_ds/"
        NEXTCLOUD_ONLYOFFICE_STORAGE_URL: "http://nextcloud/"
        NEXTCLOUD_ONLYOFFICE_VERIFY_PEER_OFF: "true"

        NEXTCLOUD_LDAP_HOST: {{ nextcloud['ldap_host'] }}
        NEXTCLOUD_LDAP_PORT: {{ nextcloud['ldap_port'] }}
        NEXTCLOUD_LDAP_BASE: {{ nextcloud['ldap_base'] }}
        NEXTCLOUD_LDAP_AGENT_NAME: {{ nextcloud['ldap_agent_name'] }}
        NEXTCLOUD_LDAP_AGENT_PASSWORD: {{ nextcloud['ldap_agent_password'] }}
        NEXTCLOUD_LDAP_EMAIL_ATTRIBUTE: {{ nextcloud['ldap_email_attribute'] }}
        NEXTCLOUD_LDAP_GID_NUMBER: {{ nextcloud['ldap_gid_number'] }}
        NEXTCLOUD_LDAP_GROUP_DISPLAY_NAME: {{ nextcloud['ldap_group_display_name'] }}
        NEXTCLOUD_LDAP_GROUP_FILTER: {{ nextcloud['ldap_group_filter'] }}
        NEXTCLOUD_LDAP_GROUP_FILTER_OBJECTCLASS: {{ nextcloud['ldap_group_filter_objectclass'] }}
        NEXTCLOUD_LDAP_GROUP_MEMBER_ASSOC_ATTR: {{ nextcloud['ldap_group_member_assoc_attr'] }}
        NEXTCLOUD_LDAP_LOGIN_FILTER: {{ nextcloud['ldap_login_filter'] }}
        NEXTCLOUD_LDAP_LOGIN_FILTER_ATTRIBUTES: {{ nextcloud['ldap_login_filter_attributes'] }}
        NEXTCLOUD_LDAP_USERDISPLAY_NAME: {{ nextcloud['ldap_userdisplay_name'] }}
        NEXTCLOUD_LDAP_USER_FILTER: {{ nextcloud['ldap_user_filter'] }}
        NEXTCLOUD_LDAP_USER_FILTER_GROUPS: {{ nextcloud['ldap_user_filter_groups'] }}
        NEXTCLOUD_LDAP_USER_FILTER_OBJECTCLASS: {{ nextcloud['ldap_user_filter_objectclass'] }}
        NEXTCLOUD_LDAP_CONFIGURATION_ACTIVE: {{ nextcloud['ldap_configuration_active'] }}
      entrypoint:
        - "/wait-for-postgres.sh"
        - "--host=nextcloud_db"
        - "--db=nextcloud"
        - "--user=nextcloud"
        - "--pass=nextcloud"
        - "--"
        - "/entrypoint.sh"
        - "apache2-foreground"
      depends_on:
        - nextcloud_db
        - nextcloud_redis
        - nextcloud_onlyoffice_ds
        - nextcloud_drawio
      networks:
        - net
